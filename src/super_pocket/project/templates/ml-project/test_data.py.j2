"""Tests for {{ project_name }} data pipelines."""
import pytest
import numpy as np
from pathlib import Path
from {{ project_name }}.config import config


def test_config_paths():
    """Test that configuration paths are set correctly."""
    assert config.data_dir.exists()
    assert config.models_dir.exists()
    assert config.random_seed == 42
    assert 0 < config.test_size < 1


def test_data_directories_exist():
    """Test that data directories exist."""
    assert config.raw_data_dir.exists()
    assert config.processed_data_dir.exists()


def test_synthetic_data_generation():
    """Test synthetic data generation for development."""
    from sklearn.datasets import make_classification

    X, y = make_classification(
        n_samples=100,
        n_features=20,
        random_state=config.random_seed
    )

    assert X.shape == (100, 20)
    assert y.shape == (100,)
    assert len(np.unique(y)) == 2  # Binary classification


def test_data_split():
    """Test data splitting functionality."""
    from sklearn.datasets import make_classification
    from sklearn.model_selection import train_test_split

    X, y = make_classification(n_samples=100, n_features=20)
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=config.test_size, random_state=config.random_seed
    )

    expected_train_size = int(100 * (1 - config.test_size))
    expected_test_size = 100 - expected_train_size

    assert len(X_train) == expected_train_size
    assert len(X_test) == expected_test_size
    assert len(y_train) == expected_train_size
    assert len(y_test) == expected_test_size


def test_data_scaling():
    """Test data scaling/normalization."""
    from sklearn.preprocessing import StandardScaler

    X = np.random.randn(100, 20)
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)

    # Check if scaled data has mean ~0 and std ~1
    assert np.abs(X_scaled.mean()) < 0.1
    assert np.abs(X_scaled.std() - 1.0) < 0.1


{% if tool_choices.framework == "pytorch" %}
def test_pytorch_tensor_conversion():
    """Test conversion to PyTorch tensors."""
    import torch

    X = np.random.randn(10, 5)
    y = np.array([0, 1, 0, 1, 0, 1, 0, 1, 0, 1])

    X_tensor = torch.FloatTensor(X)
    y_tensor = torch.LongTensor(y)

    assert X_tensor.shape == torch.Size([10, 5])
    assert y_tensor.shape == torch.Size([10])
    assert X_tensor.dtype == torch.float32
    assert y_tensor.dtype == torch.int64


{% elif tool_choices.framework == "tensorflow" %}
def test_tensorflow_tensor_conversion():
    """Test conversion to TensorFlow tensors."""
    import tensorflow as tf

    X = np.random.randn(10, 5)
    y = np.array([0, 1, 0, 1, 0, 1, 0, 1, 0, 1])

    X_tensor = tf.constant(X, dtype=tf.float32)
    y_tensor = tf.constant(y, dtype=tf.int32)

    assert X_tensor.shape == (10, 5)
    assert y_tensor.shape == (10,)
    assert X_tensor.dtype == tf.float32
    assert y_tensor.dtype == tf.int32


{% elif tool_choices.framework == "sklearn" %}
def test_model_initialization():
    """Test model initialization."""
    from sklearn.ensemble import RandomForestClassifier

    model = RandomForestClassifier(
        n_estimators=config.n_estimators,
        max_depth=config.max_depth,
        random_state=config.random_seed
    )

    assert model.n_estimators == config.n_estimators
    assert model.max_depth == config.max_depth
    assert model.random_state == config.random_seed


{% endif %}
def test_models_directory_writable():
    """Test that models directory is writable."""
    test_file = config.models_dir / "test_file.txt"
    test_file.write_text("test")
    assert test_file.exists()
    test_file.unlink()


{% if tool_choices.experiment_tracking == "mlflow" %}
def test_mlflow_config():
    """Test MLflow configuration."""
    assert config.mlflow_tracking_uri is not None
    assert config.experiment_name == "{{ project_name }}"


{% elif tool_choices.experiment_tracking == "wandb" %}
def test_wandb_config():
    """Test Weights & Biases configuration."""
    assert config.wandb_project == "{{ project_name }}"


{% endif %}
def test_random_seed_reproducibility():
    """Test that random seed ensures reproducibility."""
    np.random.seed(config.random_seed)
    sample1 = np.random.randn(10)

    np.random.seed(config.random_seed)
    sample2 = np.random.randn(10)

    assert np.allclose(sample1, sample2)
